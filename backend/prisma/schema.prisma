// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Initial schema - models will be added as features are implemented
// Connection pooling is configured via DATABASE_URL query parameters:
// - connection_limit: Maximum number of connections (default: 10)
// - pool_timeout: Connection timeout in seconds (default: 30)
// Example: postgresql://user:pass@host:5432/db?connection_limit=10&pool_timeout=30

// User model for authentication and authorization
// Requirements: 17.1, 17.4, 17.5, 1.5, 2.1, 2.2
model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique
  name         String
  passwordHash String
  role         Role
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  courses               Course[]                @relation("TeacherCourses") // Courses created by this teacher
  enrollments           Enrollment[]            // Courses enrolled in (for students)
  assignmentSubmissions AssignmentSubmission[]  // Assignment submissions by this student
  quizSubmissions       QuizSubmission[]        // Quiz submissions by this student

  @@map("users")
}


// User role enum
// Requirements: 1.5 (Each user has exactly one role: Student or Teacher)
enum Role {
  STUDENT
  TEACHER
}

// Course model for course management
// Requirements: 17.1, 17.4, 17.5, 5.1, 5.4, 5.6, 5.7
model Course {
  id          String       @id @default(uuid()) @db.Uuid
  name        String
  description String
  courseCode  String       @unique
  status      CourseStatus @default(ACTIVE)
  teacherId   String       @db.Uuid
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  teacher     User         @relation("TeacherCourses", fields: [teacherId], references: [id], onDelete: Cascade)
  materials   Material[] // Materials in this course
  enrollments Enrollment[]
  quizzes     Quiz[] // Quizzes in this course
  assignments Assignment[] // Assignments in this course

  @@map("courses")
}

// Course status enum
// Requirements: 5.4 (Course lifecycle: Active → Archived → Deleted)
enum CourseStatus {
  ACTIVE
  ARCHIVED
}

// Material model for learning materials (files, text, video links)
// Requirements: 17.1, 17.4, 17.5, 7.1, 7.2, 7.3, 7.10, 7.11
model Material {
  id        String       @id @default(uuid()) @db.Uuid
  courseId  String       @db.Uuid
  title     String
  type      MaterialType
  content   String?      @db.Text // For TEXT: HTML content; For VIDEO_LINK: URL
  filePath  String? // For FILE: path to uploaded file
  fileName  String? // For FILE: original file name
  fileSize  Int? // For FILE: file size in bytes
  mimeType  String? // For FILE: MIME type
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("materials")
}

// Material type enum
// Requirements: 7.1 (FILE), 7.2 (TEXT), 7.3 (VIDEO_LINK), 7.10 (No video file uploads)
enum MaterialType {
  FILE
  TEXT
  VIDEO_LINK
}

// Enrollment model for student course enrollment
// Requirements: 17.1, 17.4, 17.5, 6.1, 6.5, 6.8
model Enrollment {
  id         String   @id @default(uuid()) @db.Uuid
  studentId  String   @db.Uuid
  courseId   String   @db.Uuid
  enrolledAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Unique constraint: A student can only enroll once per course
  @@unique([studentId, courseId])
  @@map("enrollments")
}

// Quiz model (tetap sama)
model Quiz {
  id          String   @id @default(uuid()) @db.Uuid
  courseId    String   @db.Uuid
  title       String
  description String   @db.Text
  dueDate     DateTime
  timeLimit   Int // Time limit in minutes
  questions   Json // Array of questions (MCQ and Essay) stored as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course          Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quizSubmissions QuizSubmission[]   // Submissions for this quiz

  @@map("quizzes")
}

// Assignment model (tetap sama)
model Assignment {
  id                   String         @id @default(uuid()) @db.Uuid
  courseId             String         @db.Uuid
  title                String
  description          String         @db.Text
  dueDate              DateTime
  submissionType       SubmissionType
  acceptedFileFormats  String[]       @default([])
  gradingStarted       Boolean        @default(false)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  // Relations
  course              Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assignmentSubmissions AssignmentSubmission[] // Submissions for this assignment

  @@map("assignments")
}

// AssignmentSubmission model for assignment submissions
// Requirements: 10.6, 10.8, 10.10, 10.11, 13.3, 13.4, 13.5, 21.5
model AssignmentSubmission {
  id           String                       @id @default(uuid()) @db.Uuid
  assignmentId String                       @db.Uuid
  studentId    String                       @db.Uuid
  content      String?                      @db.Text  // Text submission content
  filePath     String?                      // File submission path
  fileName     String?                      // Original file name
  grade        Float?                       // Grade (0-100)
  feedback     String?                      @db.Text
  isLate       Boolean                      @default(false)
  status       AssignmentSubmissionStatus   @default(NOT_SUBMITTED)
  version      Int                          @default(1) // Optimistic locking
  submittedAt  DateTime?
  gradedAt     DateTime?
  createdAt    DateTime                     @default(now())
  updatedAt    DateTime                     @updatedAt

  // Relations
  student    User       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([studentId])
  @@index([assignmentId])
  @@index([status])
  @@index([studentId, status])
  @@index([assignmentId, studentId])
  
  @@map("assignment_submissions")
}

// QuizSubmission model for quiz submissions
// Requirements: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 13.3, 13.4, 13.5, 21.5
model QuizSubmission {
  id          String                 @id @default(uuid()) @db.Uuid
  quizId      String                 @db.Uuid
  studentId   String                 @db.Uuid
  answers     Json                   // Array of answers stored as JSON
  grade       Float?                 // Grade (0-100)
  feedback    String?                @db.Text
  status      QuizSubmissionStatus   @default(NOT_STARTED)
  version     Int                    @default(1) // Optimistic locking
  startedAt   DateTime?              // Quiz start time
  completedAt DateTime?              // Quiz completion time
  submittedAt DateTime?              // Quiz submission time
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  // Relations
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  quiz    Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  // Unique constraint: One submission per quiz per student
  @@unique([quizId, studentId])
  
  // Indexes
  @@index([studentId])
  @@index([quizId])
  @@index([status])
  @@index([studentId, status])
  
  @@map("quiz_submissions")
}

// AssignmentSubmission status enum
enum AssignmentSubmissionStatus {
  NOT_SUBMITTED  // Not yet submitted
  SUBMITTED      // Submitted, not yet graded
  GRADED         // Graded by teacher
}

// QuizSubmission status enum
enum QuizSubmissionStatus {
  NOT_STARTED    // Quiz not started yet
  IN_PROGRESS    // Quiz in progress
  SUBMITTED      // Quiz submitted, not yet graded
  GRADED         // Graded by teacher
}

// Enums lainnya tetap sama
enum SubmissionType {
  FILE
  TEXT
  BOTH
}

