# Prisma Migration Guide

## Purpose

This document defines the **standard migration workflow** for all database schema changes in the LMS project. Following this guide ensures consistency across all migrations and prevents confusion.

## CRITICAL: Use Docker Exec for All Prisma Commands

**⚠️ IMPORTANT:** All Prisma commands MUST be run using `docker-compose exec backend`. Running from host machine will FAIL due to PostgreSQL authentication configuration (scram-sha-256).

**✅ CORRECT:**
```bash
docker-compose exec backend npx prisma migrate dev --name add_model
```

**❌ WRONG:**
```bash
cd backend
npx prisma migrate dev --name add_model  # This will fail with authentication error!
```

**Why?**
- PostgreSQL container uses scram-sha-256 authentication
- Host machine connections fail authentication
- Container-to-container connections work correctly
- DATABASE_URL is pre-configured in docker-compose.yml

---

## Development Environment Setup

### Prerequisites

1. **Docker and Docker Compose** installed
2. **Node.js 18.20.5** installed locally (optional, for IDE support)
3. **Backend dependencies** installed in container (automatic via docker-compose)

### Start Development Databases

```bash
# From project root
docker-compose up -d postgres postgres-test

# Verify databases are running
docker-compose ps postgres postgres-test

# Check database health
docker-compose logs postgres
docker-compose logs postgres-test
```

**Database Connection Details:**

**Dev Database (postgres container):**
- Host (from container): `postgres`
- Host (from host machine): `localhost`
- Port (from host machine): `5432`
- Database: `lms_dev`
- User: `lms_user`
- Password: `dev_password` (from docker-compose.yml)
- Connection string: `postgresql://lms_user:dev_password@postgres:5432/lms_dev`

**Test Database (postgres-test container):**
- Host (from container): `postgres-test`
- Host (from host machine): `localhost`
- Port (from host machine): `5433`
- Database: `lms_test`
- User: `lms_test_user`
- Password: `test_password` (from docker-compose.yml)
- Connection string: `postgresql://lms_test_user:test_password@postgres-test:5432/lms_test`

**Note:** DATABASE_URL is configured in `docker-compose.yml` for the backend container. No `.env` file needed in backend folder.

---

## Standard Migration Workflow

**IMPORTANT:** All Prisma commands MUST be run from inside the backend Docker container using `docker-compose exec backend`. Running from host machine will fail due to PostgreSQL authentication configuration.

### Step 1: Update Prisma Schema

Edit `backend/prisma/schema.prisma` to add/modify models:

```prisma
model Material {
  id          String       @id @default(uuid()) @db.Uuid
  courseId    String       @db.Uuid
  title       String
  type        MaterialType
  // ... other fields
}
```

### Step 2: Create Migration Using Docker Exec

**CRITICAL:** Always use `docker-compose exec backend` to run Prisma commands.

```bash
# From project root
docker-compose exec backend npx prisma migrate dev --name add_material_model

# Example output:
# Migration `20260122105652_add_material_model` created
```

**What this command does:**
1. Runs Prisma CLI inside backend container
2. Generates migration SQL file with automatic timestamp
3. Applies migration to development database (postgres:5432)
4. Regenerates Prisma Client
5. Updates `_prisma_migrations` table

**Why docker exec?**
- PostgreSQL container uses scram-sha-256 authentication
- Host machine connections fail authentication
- Container-to-container connections work correctly

### Step 3: Apply Migration to Test Database

**CRITICAL:** Integration tests use a separate test database. You MUST apply migrations to the test database.

```bash
# From project root
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate deploy
```

**What this does:**
- Sets DATABASE_URL environment variable to point to test database
- Runs `migrate deploy` (applies pending migrations only)
- Connects to postgres-test container (port 5433 from host, port 5432 internally)

### Step 4: Verify Migrations

```bash
# Verify dev database
docker-compose exec backend npx prisma migrate status

# Verify test database
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate status

# Both should show: "Database schema is up to date!"
```

### Step 5: Verify Prisma Client

```bash
# Prisma Client is auto-generated by migrate dev
# Verify it includes new models
docker-compose exec backend npx prisma generate
```

### Step 6: Test Migration

```bash
# Run tests to verify migration works
docker-compose exec backend npm test

# Or run specific integration tests
docker-compose exec backend npm test -- PrismaMaterialRepository.test.ts
```

---

## Migration Naming Convention

### Automatic Timestamp Format

Prisma automatically generates timestamps in format: `YYYYMMDDHHmmss`

**Example:**
```
20260122105652_add_material_model
│         │
│         └─ Migration name (descriptive, snake_case)
└─ Timestamp (auto-generated by Prisma)
```

### Migration Name Guidelines

Use descriptive names that explain what the migration does:

✅ **GOOD:**
- `add_material_model`
- `add_enrollment_table`
- `update_course_add_status`
- `remove_unused_fields`

❌ **BAD:**
- `migration1`
- `update`
- `fix`
- `changes`

---

## Common Migration Scenarios

### Scenario 1: Add New Model

```bash
# 1. Add model to schema.prisma
# 2. Create migration using docker exec
docker-compose exec backend npx prisma migrate dev --name add_assignment_model

# 3. Apply to test database
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate deploy

# 4. Verify
docker-compose exec backend npx prisma migrate status
```

### Scenario 2: Add Field to Existing Model

```bash
# 1. Add field to schema.prisma
# 2. Create migration
docker-compose exec backend npx prisma migrate dev --name add_course_archived_field

# 3. Apply to test database
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate deploy

# 4. Verify
docker-compose exec backend npm test
```

### Scenario 3: Add Relation Between Models

```bash
# 1. Add relation fields to both models in schema.prisma
# 2. Create migration
docker-compose exec backend npx prisma migrate dev --name add_course_material_relation

# 3. Apply to test database
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate deploy

# 4. Verify foreign keys
docker-compose exec postgres psql -U lms_user -d lms_dev -c "\d materials"
```

### Scenario 4: Add Enum Type

```bash
# 1. Add enum to schema.prisma
# 2. Create migration
docker-compose exec backend npx prisma migrate dev --name add_material_type_enum

# 3. Apply to test database
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate deploy

# 4. Verify enum
docker-compose exec postgres psql -U lms_user -d lms_dev -c "\dT"
```

---

## Troubleshooting

### Problem: DATABASE_URL not set

**Error:**
```
Environment variable not found: DATABASE_URL
```

**Solution:**
**ALWAYS use `docker-compose exec backend` to run Prisma commands.** The backend container has DATABASE_URL configured in docker-compose.yml.

```bash
# ✅ CORRECT - Run from inside container
docker-compose exec backend npx prisma migrate dev --name add_model

# ❌ WRONG - Don't run from host machine
cd backend
npx prisma migrate dev --name add_model  # This will fail!
```

### Problem: Authentication failed

**Error:**
```
P1000: Authentication failed against database server
```

**Root Cause:**
- PostgreSQL uses scram-sha-256 authentication
- Host machine connections fail authentication
- Only container-to-container connections work

**Solution:**
**ALWAYS use `docker-compose exec backend` to run Prisma commands.**

```bash
# ✅ CORRECT - Run from inside container
docker-compose exec backend npx prisma migrate dev --name add_model

# ❌ WRONG - Don't run from host machine
npx prisma migrate dev --name add_model  # Authentication will fail!
```

### Problem: Migration already exists

**Error:**
```
Migration `20260122105652_add_material_model` already exists
```

**Solution:**
```bash
# Option 1: Reset database (development only!)
npx prisma migrate reset

# Option 2: Delete migration folder and recreate
rm -rf backend/prisma/migrations/20260122105652_add_material_model
npx prisma migrate dev --name add_material_model
```

### Problem: Prisma Client out of sync

**Error:**
```
Prisma Client is not up to date
```

**Solution:**
```bash
# Regenerate Prisma Client
npx prisma generate

# Or run migration again
npx prisma migrate dev
```

### Problem: Integration tests fail with "table does not exist"

**Error:**
```
PrismaClientKnownRequestError: The table `public.materials` does not exist in the current database
```

**Root Cause:**
- Migration was applied to dev database but NOT to test database
- Integration tests use test database (postgres-test container)

**Solution:**
```bash
# Apply migration to test database using docker exec
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate deploy

# Verify migration was applied
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate status

# Run tests again
docker-compose exec backend npm test -- PrismaMaterialRepository.test.ts
```

**Prevention:**
- ALWAYS apply migrations to BOTH dev and test databases
- Use the commands in Step 2 and Step 3 of Standard Migration Workflow

---

## Production Migrations

### Deployment Migration Workflow

**IMPORTANT:** Never use `migrate dev` in production!

```bash
# In production environment
npx prisma migrate deploy

# This command:
# - Applies pending migrations
# - Does NOT create new migrations
# - Does NOT reset database
# - Safe for production use
```

### CI/CD Pipeline

```yaml
# .github/workflows/deploy.yml
- name: Run database migrations
  run: |
    cd backend
    npx prisma migrate deploy
```

---

## Migration Checklist

Before committing a migration, verify:

- [ ] Migration created with `docker-compose exec backend npx prisma migrate dev`
- [ ] Migration file has descriptive name
- [ ] Migration SQL is correct (review generated SQL)
- [ ] Prisma Client regenerated (automatic with migrate dev)
- [ ] Migration applied to test database (`docker-compose exec -e DATABASE_URL=... backend npx prisma migrate deploy`)
- [ ] Integration tests pass (`docker-compose exec backend npm test`)
- [ ] Unit tests pass (`docker-compose exec backend npm test`)
- [ ] TypeScript compiles (`docker-compose exec backend npm run build`)
- [ ] Migration committed to Git (including migration folder)
- [ ] **NO `.env` file in backend folder** (not needed, uses docker-compose.yml)

---

## Best Practices

### ✅ DO

1. **ALWAYS use `docker-compose exec backend`** for all Prisma commands
2. **Apply migrations to BOTH databases** (dev and test)
3. **Use descriptive migration names** (snake_case)
4. **Review generated SQL** before committing
5. **Test migrations** before committing
6. **Commit migration files** to Git
7. **Use `npx prisma migrate deploy`** in production (inside container)

### ❌ DON'T

1. **Don't run Prisma commands from host machine** (authentication will fail)
2. **Don't manually create migration files** (let Prisma generate them)
3. **Don't use custom timestamps** (let Prisma auto-generate)
4. **Don't skip migration testing**
5. **Don't skip test database migration** (causes "table does not exist" errors)
6. **Don't commit `.env` files**
7. **Don't use `migrate dev` in production**
8. **Don't modify existing migrations** (create new ones instead)
9. **Don't reset production database** (use `migrate deploy` only)

---

## Quick Reference

### Common Commands

**CRITICAL:** All commands MUST use `docker-compose exec backend`

```bash
# Start development databases
docker-compose up -d postgres postgres-test

# Create new migration (applies to dev database)
docker-compose exec backend npx prisma migrate dev --name <migration_name>

# Apply migration to test database
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate deploy

# Check migration status (dev database)
docker-compose exec backend npx prisma migrate status

# Check migration status (test database)
docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate status

# Generate Prisma Client
docker-compose exec backend npx prisma generate

# View database in GUI
docker-compose exec backend npx prisma studio

# Run tests
docker-compose exec backend npm test
```

### Environment Variables

```bash
# Development Database (from docker-compose.yml)
DATABASE_URL=postgresql://lms_user:dev_password@localhost:5432/lms_dev

# Test Database (from docker-compose.yml)
TEST_DATABASE_URL=postgresql://lms_test_user:test_password@localhost:5433/lms_test

# For applying migration to test database
$env:DATABASE_URL="postgresql://lms_test_user:test_password@localhost:5433/lms_test"

# Production (from .env.production)
DATABASE_URL=postgresql://lms_user:${DB_PASSWORD}@postgres:5432/lms_prod
```

**Important:**
- Dev database: port 5432 (used by `migrate dev`)
- Test database: port 5433 (used by Jest integration tests)
- Always apply migrations to BOTH databases

---

## Summary

**Standard Migration Workflow:**

1. Start Docker Compose: `docker-compose up -d postgres postgres-test`
2. Update schema: Edit `backend/prisma/schema.prisma`
3. Create migration: `docker-compose exec backend npx prisma migrate dev --name <name>`
4. Apply to test DB: `docker-compose exec -e DATABASE_URL="postgresql://lms_test_user:test_password@postgres-test:5432/lms_test" backend npx prisma migrate deploy`
5. Verify: `docker-compose exec backend npm test`
6. Commit: Git commit migration files

**Key Points:**
- ✅ **ALWAYS use `docker-compose exec backend`** for all Prisma commands
- ✅ Apply migrations to BOTH dev and test databases
- ✅ Let Prisma auto-generate timestamps
- ✅ Use Docker Compose for local databases
- ❌ **NEVER run Prisma commands from host machine** (authentication will fail)
- ❌ Never manually create migration files
- ❌ Never use custom timestamps
- ❌ Never skip test database migration (causes "table does not exist" errors)

**Why docker exec?**
- PostgreSQL uses scram-sha-256 authentication
- Host machine connections fail authentication
- Container-to-container connections work correctly
- DATABASE_URL is pre-configured in docker-compose.yml

---

## References

- **Prisma Migrate Docs**: https://www.prisma.io/docs/concepts/components/prisma-migrate
- **Docker Compose**: `docker-compose.yml` in project root
- **Environment Variables**: `backend/.env.example`
- **Prisma Schema**: `backend/prisma/schema.prisma`
