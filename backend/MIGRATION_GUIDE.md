# Prisma Migration Guide

## Purpose

This document defines the **standard migration workflow** for all database schema changes in the LMS project. Following this guide ensures consistency across all migrations and prevents confusion.

---

## Development Environment Setup

### Prerequisites

1. **Docker and Docker Compose** installed
2. **Node.js 18.20.5** installed locally
3. **Backend dependencies** installed (`npm install` in backend folder)

### Start Development Database

```bash
# From project root
docker-compose up -d postgres

# Verify database is running
docker-compose ps postgres

# Check database health
docker-compose logs postgres
```

**Database Connection Details:**
- Host: `localhost`
- Port: `5432`
- Database: `lms_dev`
- User: `lms_user`
- Password: `dev_password` (from docker-compose.yml)

---

## Standard Migration Workflow

### Step 1: Update Prisma Schema

Edit `backend/prisma/schema.prisma` to add/modify models:

```prisma
model Material {
  id          String       @id @default(uuid()) @db.Uuid
  courseId    String       @db.Uuid
  title       String
  type        MaterialType
  // ... other fields
}
```

### Step 2: Create Migration with Prisma CLI

**IMPORTANT:** Always use `npx prisma migrate dev` for development migrations.

```bash
# Navigate to backend folder
cd backend

# Create migration (Prisma will auto-generate timestamp)
npx prisma migrate dev --name add_material_model

# Example output:
# Migration `20260122105652_add_material_model` created
```

**What this command does:**
1. Generates migration SQL file with automatic timestamp
2. Applies migration to development database
3. Regenerates Prisma Client
4. Updates `_prisma_migrations` table

### Step 3: Verify Migration

```bash
# Check migration was created
ls backend/prisma/migrations/

# Verify database schema
npx prisma studio

# Or connect to database directly
docker-compose exec postgres psql -U lms_user -d lms_dev
\dt  # List tables
\d materials  # Describe materials table
```

### Step 4: Generate Prisma Client

```bash
# Generate Prisma Client (usually done automatically by migrate dev)
npx prisma generate
```

### Step 5: Test Migration

```bash
# Run tests to verify migration works
npm test

# Or run specific tests
npm test -- Material.test.ts
```

---

## Migration Naming Convention

### Automatic Timestamp Format

Prisma automatically generates timestamps in format: `YYYYMMDDHHmmss`

**Example:**
```
20260122105652_add_material_model
│         │
│         └─ Migration name (descriptive, snake_case)
└─ Timestamp (auto-generated by Prisma)
```

### Migration Name Guidelines

Use descriptive names that explain what the migration does:

✅ **GOOD:**
- `add_material_model`
- `add_enrollment_table`
- `update_course_add_status`
- `remove_unused_fields`

❌ **BAD:**
- `migration1`
- `update`
- `fix`
- `changes`

---

## Common Migration Scenarios

### Scenario 1: Add New Model

```bash
# 1. Add model to schema.prisma
# 2. Create migration
npx prisma migrate dev --name add_assignment_model

# 3. Verify
npx prisma studio
```

### Scenario 2: Add Field to Existing Model

```bash
# 1. Add field to schema.prisma
# 2. Create migration
npx prisma migrate dev --name add_course_archived_field

# 3. Verify
npm test
```

### Scenario 3: Add Relation Between Models

```bash
# 1. Add relation fields to both models in schema.prisma
# 2. Create migration
npx prisma migrate dev --name add_course_material_relation

# 3. Verify foreign keys
docker-compose exec postgres psql -U lms_user -d lms_dev
\d materials  # Check foreign key constraints
```

### Scenario 4: Add Enum Type

```bash
# 1. Add enum to schema.prisma
# 2. Create migration
npx prisma migrate dev --name add_material_type_enum

# 3. Verify enum
docker-compose exec postgres psql -U lms_user -d lms_dev
\dT  # List types
```

---

## Troubleshooting

### Problem: DATABASE_URL not set

**Error:**
```
Environment variable not found: DATABASE_URL
```

**Solution:**
```bash
# Option 1: Create .env file in backend folder
cp backend/.env.example backend/.env

# Option 2: Set environment variable
export DATABASE_URL="postgresql://lms_user:dev_password@localhost:5432/lms_dev"

# Option 3: Use Docker Compose (recommended)
docker-compose up -d postgres
# DATABASE_URL is automatically set in docker-compose.yml
```

### Problem: Database connection refused

**Error:**
```
Can't reach database server at `localhost:5432`
```

**Solution:**
```bash
# Start PostgreSQL container
docker-compose up -d postgres

# Wait for database to be ready
docker-compose logs -f postgres
# Look for: "database system is ready to accept connections"

# Verify connection
docker-compose exec postgres psql -U lms_user -d lms_dev -c "SELECT 1"
```

### Problem: Migration already exists

**Error:**
```
Migration `20260122105652_add_material_model` already exists
```

**Solution:**
```bash
# Option 1: Reset database (development only!)
npx prisma migrate reset

# Option 2: Delete migration folder and recreate
rm -rf backend/prisma/migrations/20260122105652_add_material_model
npx prisma migrate dev --name add_material_model
```

### Problem: Prisma Client out of sync

**Error:**
```
Prisma Client is not up to date
```

**Solution:**
```bash
# Regenerate Prisma Client
npx prisma generate

# Or run migration again
npx prisma migrate dev
```

---

## Production Migrations

### Deployment Migration Workflow

**IMPORTANT:** Never use `migrate dev` in production!

```bash
# In production environment
npx prisma migrate deploy

# This command:
# - Applies pending migrations
# - Does NOT create new migrations
# - Does NOT reset database
# - Safe for production use
```

### CI/CD Pipeline

```yaml
# .github/workflows/deploy.yml
- name: Run database migrations
  run: |
    cd backend
    npx prisma migrate deploy
```

---

## Migration Checklist

Before committing a migration, verify:

- [ ] Migration created with `npx prisma migrate dev`
- [ ] Migration file has descriptive name
- [ ] Migration SQL is correct (review generated SQL)
- [ ] Prisma Client regenerated (`npx prisma generate`)
- [ ] Tests pass (`npm test`)
- [ ] TypeScript compiles (`npm run build`)
- [ ] Migration committed to Git (including migration folder)
- [ ] `.env` file NOT committed (only `.env.example`)

---

## Best Practices

### ✅ DO

1. **Always use Docker Compose** for development database
2. **Always use `npx prisma migrate dev`** for creating migrations
3. **Use descriptive migration names** (snake_case)
4. **Review generated SQL** before committing
5. **Test migrations** before committing
6. **Commit migration files** to Git
7. **Use `npx prisma migrate deploy`** in production

### ❌ DON'T

1. **Don't manually create migration files** (let Prisma generate them)
2. **Don't use custom timestamps** (let Prisma auto-generate)
3. **Don't skip migration testing**
4. **Don't commit `.env` files**
5. **Don't use `migrate dev` in production**
6. **Don't modify existing migrations** (create new ones instead)
7. **Don't reset production database** (use `migrate deploy` only)

---

## Quick Reference

### Common Commands

```bash
# Start development database
docker-compose up -d postgres

# Create new migration
cd backend
npx prisma migrate dev --name <migration_name>

# Apply migrations (production)
npx prisma migrate deploy

# Reset database (development only!)
npx prisma migrate reset

# View database in GUI
npx prisma studio

# Generate Prisma Client
npx prisma generate

# Check migration status
npx prisma migrate status
```

### Environment Variables

```bash
# Development (from docker-compose.yml)
DATABASE_URL=postgresql://lms_user:dev_password@localhost:5432/lms_dev

# Test (from docker-compose.yml)
DATABASE_URL=postgresql://lms_test_user:test_password@localhost:5433/lms_test

# Production (from .env.production)
DATABASE_URL=postgresql://lms_user:${DB_PASSWORD}@postgres:5432/lms_prod
```

---

## Summary

**Standard Migration Workflow:**

1. Start Docker Compose: `docker-compose up -d postgres`
2. Update schema: Edit `backend/prisma/schema.prisma`
3. Create migration: `npx prisma migrate dev --name <name>`
4. Verify: `npm test` and `npx prisma studio`
5. Commit: Git commit migration files

**Key Points:**
- ✅ Use `npx prisma migrate dev` for development
- ✅ Use `npx prisma migrate deploy` for production
- ✅ Let Prisma auto-generate timestamps
- ✅ Use Docker Compose for local database
- ❌ Never manually create migration files
- ❌ Never use custom timestamps

---

## References

- **Prisma Migrate Docs**: https://www.prisma.io/docs/concepts/components/prisma-migrate
- **Docker Compose**: `docker-compose.yml` in project root
- **Environment Variables**: `backend/.env.example`
- **Prisma Schema**: `backend/prisma/schema.prisma`
